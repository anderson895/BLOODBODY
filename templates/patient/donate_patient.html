{% include '/components/header.html' %}
<body class="bg-white from-red-700 to-white min-h-screen flex flex-col">
    {% include 'PageSpinner.html' %}

    <!-- Navbar -->
    <nav class="bg-[#a22133] text-white py-4 px-8 flex justify-between items-center shadow-lg">
        <div class="flex items-center space-x-3">
            <img src="/static/ELEMENTS/LOGO.png" alt="BloodBuddy Logo" class="h-10">
            <span class="text-xl font-bold tracking-wide">BLOODBUDDY</span>
        </div>

        <div class="hidden md:flex space-x-6 items-center">
            <a href="/patient/home_patient" class="text-white hover:underline">HOME</a>
            <a href="/patient/about_patient" class="text-white hover:underline">ABOUT</a>
            <a href="/patient/donate_patient" class="bg-pink-200 text-red-800 px-5 py-2 rounded-full font-semibold shadow-md hover:bg-pink-300">DONATE</a>
        </div>
    </nav>

    <!-- Blood List Section -->
    <div class="container mx-auto mt-10 p-6 bg-white shadow-lg rounded-lg">
        <h2 class="text-2xl font-bold text-red-700 mb-4">Blood Donations</h2>

        <table class="min-w-full bg-white border border-gray-200 shadow-md rounded-lg overflow-hidden">
            <thead class="bg-red-700 text-white">
                <tr>
                    <th class="py-3 px-6 text-left">#</th>
                    <th class="py-3 px-6 text-left">Donor Name</th>
                    <th class="py-3 px-6 text-left">Blood Type</th>
                    <th class="py-3 px-6 text-left">City</th>
                    <th class="py-3 px-6 text-left">Contact</th>
                    <th class="py-3 px-6 text-left">Actions</th> <!-- Updated Column for Remove & Done Buttons -->
                </tr>
            </thead>
            <tbody id="blood-list" class="text-gray-700"></tbody>
        </table>
    </div>

    <script>
       $(document).ready(function() {
    function fetchBloodList() {
        $.ajax({
            url: "/get-blood-list?patient_id={{ session['patient_id'] }}",
            type: "GET",
            dataType: "json",
            success: function(response) {
                console.log(response);

                let tableBody = "";
                if (response.length > 0) {
                    response.forEach((blood, index) => {
                        let actionButtons = '';

                        if (blood.donor_status === "Done") {
                            actionButtons = `<span class="text-green-600 font-bold">Mark as Done</span>`;
                        } else {
                            actionButtons = `
                                <button class="done-btn bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" 
                                    data-id="${blood.id}">
                                    Done
                                </button>
                                <button class="remove-btn bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600" 
                                    data-id="${blood.id}">
                                    Remove
                                </button>`;
                        }

                        tableBody += `
                            <tr class="border-b" data-id="${blood.id}">
                                <td class="py-3 px-6">${index + 1}</td>
                                <td class="py-3 px-6">${blood.donor_name}</td>
                                <td class="py-3 px-6">${blood.donor_bloodtype}</td>
                                <td class="py-3 px-6">${blood.donor_city}</td>
                                <td class="py-3 px-6">${blood.donor_contact}</td>
                                <td class="py-3 px-6">${actionButtons}</td>
                            </tr>`;
                    });
                } else {
                    tableBody = `<tr><td colspan="6" class="text-center py-4">No blood donations found.</td></tr>`;
                }
                $("#blood-list").html(tableBody);
            },
            error: function(xhr, status, error) {
                console.error("Failed to fetch data: ", error);
                $("#blood-list").html(`<tr><td colspan="6" class="text-center py-4 text-red-600">Failed to load data.</td></tr>`);
            }
        });
    }

    // Initial load
    fetchBloodList();

    // Remove button click event
    $(document).on("click", ".remove-btn", function() {
        let donationId = $(this).data("id");

        if (confirm("Are you sure you want to remove this donation?")) {
            $.ajax({
                url: "/remove-blood-donation",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ donation_id: donationId }),
                success: function(response) {
                    alert("Donation removed successfully.");
                    fetchBloodList(); // Refresh the list
                },
                error: function(xhr, status, error) {
                    console.error("Failed to remove donation: ", error);
                    alert("Failed to remove the donation.");
                }
            });
        }
    });

    // Done button click event
    $(document).on("click", ".done-btn", function() {
        let donationId = $(this).data("id");

        if (confirm("Mark this donation as done?")) {
            $.ajax({
                url: "/mark-blood-donation-done",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ donation_id: donationId }),
                success: function(response) {
                    alert("Donation marked as done.");
                    fetchBloodList(); // Refresh the list
                },
                error: function(xhr, status, error) {
                    console.error("Failed to mark as done: ", error);
                    alert("Failed to update donation status.");
                }
            });
        }
    });
});

    </script>
</body>

{% include '/components/footer.html' %}
